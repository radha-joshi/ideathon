<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReCircuit ‚Äî Eco Marketplace</title>
    <script>
        // Tailwind config: keep default emerald & slate palette
        tailwind = {
            config: {
                theme: {
                    extend: {
                        fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root{
            --glass-bg: rgba(255,255,255,0.64);
            --glass-border: rgba(148,163,184,0.12);
            --glass-shadow: 0 10px 30px rgba(2,6,23,0.08);
        }
        body{ font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }
        .glass {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(8px) saturate(120%);
            -webkit-backdrop-filter: blur(8px) saturate(120%);
            box-shadow: var(--glass-shadow);
        }
        .btn-tactile{
            transition: transform .08s ease, box-shadow .12s ease;
        }
        .btn-tactile:active{ transform: translateY(2px) scale(.998); }
        .fade-in{ animation: fadeIn .28s ease both; }
        @keyframes fadeIn{ from{opacity:0; transform: translateY(8px)} to{opacity:1; transform:none} }
        /* Orientation / device responsive tweaks */
        /* Ensure grid adapts when device is in landscape or portrait */
        #items-grid { display: grid; grid-template-columns: repeat(1, minmax(0,1fr)); }
        #items-grid article img { height: 180px; }

        @media (min-width: 640px) {
            #items-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
        }
        @media (min-width: 1024px) {
            #items-grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
        }

        @media (orientation: landscape) and (max-width: 640px) {
            /* small devices in landscape: show two columns */
            #items-grid { grid-template-columns: repeat(2, minmax(0,1fr)); }
            #items-grid article img { height: 220px; }
        }

        @media (orientation: portrait) and (max-width: 640px) {
            /* small devices in portrait: single column, smaller images */
            #items-grid { grid-template-columns: repeat(1, minmax(0,1fr)); }
            #items-grid article img { height: 180px; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- PERSISTENT GLOBAL NAVBAR (Visible when logged in) -->
    <header id="global-navbar" class="hidden glass sticky top-4 mx-auto max-w-5xl w-full px-4 py-3 rounded-2xl flex items-center justify-between gap-4 shadow-xl mt-4 mb-4 z-40" style="align-self: center;">
        <div class="flex items-center gap-3 cursor-pointer" onclick="navTo('view-dashboard')">
            <div class="w-10 h-10 bg-emerald-600 rounded-2xl flex items-center justify-center text-white font-bold">R</div>
            <div>
                <div class="text-slate-800 font-bold">ReCircuit</div>
                <div class="text-xs text-slate-500">Clean Tech Marketplace</div>
            </div>
        </div>

        <!-- Desktop Links -->
        <nav class="hidden md:flex items-center gap-4">
            <input id="search-bar" placeholder="Search items, sellers, cities..." class="px-4 py-2 rounded-xl border border-slate-200 bg-white/80 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 w-48" oninput="handleSearch()">
            
            <button onclick="navTo('view-dashboard')" id="nav-dashboard" class="text-sm px-3 py-2 pb-2 border-b-2 border-transparent text-slate-700 hover:text-slate-900 transition font-medium">üìä Dashboard</button>
            
            <button onclick="navTo('view-form')" id="nav-sell" class="text-sm px-3 py-2 pb-2 border-b-2 border-transparent text-slate-700 hover:text-slate-900 transition font-medium">‚ûï Sell Waste</button>
            
            <button onclick="doLogout()" class="text-sm px-3 py-2 rounded-lg text-slate-500 hover:text-slate-900 transition">Logout</button>
            <img id="profile-avatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Radha" class="w-9 h-9 rounded-full border border-slate-200 bg-slate-100 cursor-pointer hover:ring-2 hover:ring-emerald-500 transition" onclick="openProfileModal()">
        </nav>

        <!-- Mobile controls -->
        <div class="flex md:hidden items-center gap-3">
            <input id="search-bar-mobile" placeholder="Search" class="px-3 py-2 rounded-lg border border-slate-200 bg-white/80 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500 w-36" oninput="handleSearch()">
            <button id="hamburger-btn" onclick="toggleMobileMenu()" class="p-2 rounded-lg bg-white/30 hover:bg-white/50 transition">
                <!-- simple hamburger SVG -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>
        </div>
    </header>

    <!-- Mobile Menu Dropdown (hidden by default) -->
    <div id="mobile-menu" class="hidden md:hidden max-w-5xl mx-auto mt-2 px-4 w-full" style="position:relative; z-index:40;">
        <div class="glass rounded-xl p-4 flex flex-col gap-3">
            <button onclick="navTo('view-dashboard'); closeMobileMenu()" class="text-left text-slate-700 font-medium px-3 py-2 rounded-lg hover:bg-slate-50">üìä Dashboard</button>
            <button onclick="navTo('view-form'); closeMobileMenu()" class="text-left text-slate-700 font-medium px-3 py-2 rounded-lg hover:bg-slate-50">‚ûï Sell Waste</button>
            <button onclick="openProfileModal(); closeMobileMenu()" class="text-left text-slate-700 font-medium px-3 py-2 rounded-lg hover:bg-slate-50">Profile</button>
            <button onclick="doLogout(); closeMobileMenu()" class="text-left text-slate-500 px-3 py-2 rounded-lg hover:bg-slate-50">Logout</button>
        </div>
    </div>

    <main id="main-content" class="flex-1 flex flex-col w-full">

    <!-- LOGIN VIEW -->
    <section id="view-login" class="min-h-screen flex items-center justify-center p-6">
        <div class="glass rounded-2xl p-8 max-w-md w-full">
            <div class="text-center mb-6">
                <div class="w-14 h-14 bg-emerald-600/95 rounded-2xl inline-flex items-center justify-center text-white text-2xl font-bold">R</div>
                <h1 class="text-2xl font-extrabold text-slate-900 mt-4">ReCircuit</h1>
                <p class="text-sm text-slate-500 mt-1">Give electronics a second life ‚Äî safely.</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Username</label>
                    <input id="username" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="radha">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Password</label>
                    <input id="password" type="password" class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="project2026">
                </div>

                <div id="login-error" class="hidden text-sm text-red-600 bg-red-50 p-3 rounded-lg">‚ö†Ô∏è Invalid credentials</div>

                <button id="btn-login" class="w-full mt-1 py-3 rounded-2xl bg-gradient-to-b from-emerald-600 to-emerald-500 text-white font-bold btn-tactile shadow-lg">Sign in</button>
            </form>

            <p class="text-center text-xs text-slate-400 mt-4">User: <strong>radha</strong> | Pass: <strong>project2026</strong></p>
        </div>
    </section>

    <!-- DASHBOARD -->
    <section id="view-dashboard" class="hidden min-h-screen flex flex-col">
        <div class="max-w-5xl mx-auto px-4 py-8 w-full">
            <div class="mb-6">
                <h2 class="text-xl font-extrabold text-slate-900">Community Listings</h2>
                <p class="text-sm text-slate-500">Items available near you</p>
            </div>

            <!-- FILTER PANEL -->
            <div class="bg-white rounded-xl border border-slate-200 p-4 mb-6 shadow-sm">
                <!-- Filter Row 1: Price, Location, Condition -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="text-xs font-semibold text-slate-600 block mb-2">Price (‚Çπ)</label>
                        <div class="flex gap-2 items-center">
                            <input type="number" id="filter-price-min" placeholder="Min" class="w-16 px-2 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <span class="text-slate-400 text-xs">to</span>
                            <input type="number" id="filter-price-max" placeholder="Max" class="w-16 px-2 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <button onclick="applyFilters()" class="px-3 py-2 bg-emerald-600 text-white text-sm font-semibold rounded-lg hover:bg-emerald-700 transition whitespace-nowrap">Go</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-600 block mb-2">Location</label>
                        <select id="filter-location" onchange="applyFilters()" class="w-full px-2 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">All Locations</option>
                            <option value="Main Campus">Main Campus</option>
                            <option value="Girls Hostel">Girls Hostel</option>
                            <option value="IT Park">IT Park</option>
                            <option value="Civil Lines">Civil Lines</option>
                            <option value="Hostels">Hostels</option>
                            <option value="Nearby">Nearby</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-600 block mb-2">Condition</label>
                        <select id="filter-condition" onchange="applyFilters()" class="w-full px-2 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="">Any Condition</option>
                            <option value="works">Working</option>
                            <option value="partial">Repairable</option>
                            <option value="dead">Scrap</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-xs font-semibold text-slate-600 block mb-2">Sort By</label>
                        <select id="filter-sort" onchange="applyFilters()" class="w-full px-2 py-2 border border-slate-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option value="newest">Newest First</option>
                            <option value="price-asc">Price (Low to High)</option>
                            <option value="price-desc">Price (High to Low)</option>
                        </select>
                    </div>
                </div>

                <!-- Active Filters Row -->
                <div id="active-filters" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- ITEMS GRID -->
            <div id="items-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            
            <!-- EMPTY STATE -->
            <div id="empty-state" class="hidden text-center py-12">
                <div class="text-6xl mb-4">üì¶</div>
                <h3 class="text-xl font-bold text-slate-900 mb-2">No items found</h3>
                <p class="text-slate-600">Try adjusting your filters or search terms</p>
                <button onclick="resetFilters()" class="mt-4 px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition font-semibold">Clear Filters</button>
            </div>
        </div>
    </section>

    <!-- PRODUCT DETAIL VIEW -->
    <section id="view-details" class="hidden min-h-screen flex items-start justify-center p-6">
        <div class="max-w-3xl w-full">
            <div class="glass rounded-2xl p-5 mb-6">
                <div class="flex items-center justify-between">
                    <button onclick="goBack()" class="text-slate-600">‚Üê Back</button>
                    <div></div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6">
                <div class="flex flex-col gap-6">
                    <div>
                        <h1 id="detail-title" class="text-2xl font-extrabold text-slate-900">Item Title</h1>
                        <div class="mt-3 flex items-center gap-3">
                            <div id="detail-price" class="text-2xl font-extrabold text-emerald-600">‚Çπ0</div>
                            <div id="detail-condition" class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">Condition</div>
                        </div>

                        <p id="detail-desc" class="text-slate-600 mt-4">Full description here.</p>
                    </div>

                    <div class="p-4 rounded-lg bg-slate-50 cursor-pointer hover:bg-slate-100 transition" onclick="openSellerProfile()">
                        <div class="text-sm text-slate-500">Seller</div>
                        <div class="flex items-center gap-3 mt-2">
                            <img id="detail-seller-avatar" src="" class="w-10 h-10 rounded-full">
                            <div class="flex-1">
                                <div id="detail-seller-name" class="font-bold text-slate-900"></div>
                                <div id="detail-seller-rating" class="text-xs text-slate-500"></div>
                            </div>
                            <div class="text-slate-400">‚Üí</div>
                        </div>
                    </div>

                    <button id="btn-buy" onclick="handleBuyOrClaim()" class="w-full py-3 rounded-2xl bg-emerald-600 text-white font-bold btn-tactile shadow-lg hover:bg-emerald-700">Buy Now</button>

                    <div class="text-center">
                        <button id="pickup-link" onclick="openPickup()" class="text-sm text-slate-600 hover:text-slate-900 hover:underline hidden">Item not selling? Schedule Recycler Pickup</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SELL FORM (Category-first flow) -->
    <section id="view-form" class="hidden min-h-screen flex flex-col">
        <div class="glass mx-auto max-w-3xl w-full p-6 rounded-2xl mt-8 shadow-xl">
            <div class="flex items-center justify-between mb-4">
                <button onclick="goBack()" class="text-slate-600 hover:text-slate-900">‚Üê Back</button>
                <h3 class="font-bold text-lg text-slate-900">List an Item</h3>
                <div></div>
            </div>

            <!-- Step 1: Category Grid -->
            <div id="category-grid" class="space-y-6">
                <h2 class="text-xl font-bold text-slate-900">What are you listing?</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <div class="glass p-4 rounded-2xl cursor-pointer hover:shadow-lg transition" onclick="chooseCategory('smartphone')">
                        <div class="text-2xl">üì±</div>
                        <div class="font-bold mt-2">Smartphone</div>
                        <div class="text-xs text-slate-500">Screen, storage, battery</div>
                    </div>
                    <div class="glass p-4 rounded-2xl cursor-pointer hover:shadow-lg transition" onclick="chooseCategory('laptop')">
                        <div class="text-2xl">üíª</div>
                        <div class="font-bold mt-2">Laptop</div>
                        <div class="text-xs text-slate-500">Processor, RAM, Battery</div>
                    </div>
                    <div class="glass p-4 rounded-2xl cursor-pointer hover:shadow-lg transition" onclick="chooseCategory('monitor')">
                        <div class="text-2xl">üñ•Ô∏è</div>
                        <div class="font-bold mt-2">Monitor / TV</div>
                        <div class="text-xs text-slate-500">Screen size, dead pixels</div>
                    </div>
                    <div class="glass p-4 rounded-2xl cursor-pointer hover:shadow-lg transition" onclick="chooseCategory('pccomponent')">
                        <div class="text-2xl">üéÆ</div>
                        <div class="font-bold mt-2">PC Component</div>
                        <div class="text-xs text-slate-500">Part name, model, VRAM</div>
                    </div>
                    <div class="glass p-4 rounded-2xl cursor-pointer hover:shadow-lg transition col-span-2 sm:col-span-1" onclick="chooseCategory('other')">
                        <div class="text-2xl">üîå</div>
                        <div class="font-bold mt-2">Other / Cables</div>
                        <div class="text-xs text-slate-500">Generic listing</div>
                    </div>
                </div>

                <div>
                    <button onclick="openPickup();" class="w-full py-3 rounded-2xl border-2 border-red-400 text-red-600 bg-transparent font-bold">Wait, this is just scrap junk. Schedule Recycler Pickup directly</button>
                </div>
            </div>

            <!-- Step 2: Dynamic Form (hidden initially) -->
            <div id="category-form" class="hidden">
                <div class="flex items-center justify-between mb-4">
                    <button onclick="showCategoryGrid()" class="text-sm text-slate-600 hover:text-slate-900">‚Üê Back to Categories</button>
                    <div class="flex items-center gap-3">
                        <label class="text-sm text-slate-700 mr-2">Pro Mode</label>
                        <input id="pro-mode-toggle" type="checkbox" class="h-5 w-10 rounded-full accent-emerald-600" />
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <div class="text-sm text-slate-600">Category: <span id="selected-category-label" class="font-bold text-slate-800"></span></div>
                    <button id="change-category-btn" onclick="changeCategory()" class="text-sm px-3 py-1 rounded-lg bg-slate-100 hover:bg-slate-50">Change Category</button>
                </div>

                <form id="sell-form" class="space-y-6" onsubmit="handlePost(event)">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Item title</label>
                        <input id="item-title" required class="w-full p-3 rounded-xl border border-slate-200 bg-white/60 focus:outline-none focus:ring-2 focus:ring-emerald-400" placeholder="e.g. Fried GPU">
                    </div>

                    <div id="dynamic-fields"></div>
                    <div id="dynamic-pro-fields" class="hidden"></div>

                    <div id="common-fields" class="space-y-4">
                        <div id="battery-warning" class="hidden p-3 rounded-lg bg-yellow-50 border border-yellow-100 text-yellow-800 text-sm">
                            <strong>Safety check:</strong> Is the battery swollen or leaking? If yes, do not transport loosely ‚Äî follow disposal guidelines.
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Price (optional)</label>
                                <div class="flex items-center gap-2">
                                    <input id="item-price" class="flex-1 p-3 rounded-xl border border-slate-200 bg-white/60 focus:outline-none" placeholder="e.g. 1500 or FREE">
                                    <button type="button" id="suggested-price-btn" class="px-3 py-2 rounded-lg bg-emerald-50 text-emerald-700 font-bold text-sm hover:bg-emerald-100">Suggested Price</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Attach image (optional)</label>
                                <input id="item-image" type="file" accept="image/*" class="w-full text-sm text-slate-600">
                                <img id="image-preview" src="" class="mt-3 w-36 h-24 object-cover rounded-lg hidden" alt="preview">
                            </div>
                        </div>

                        <!-- Description -->
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-2">Description</label>
                            <textarea id="item-desc" placeholder="Any other issues?" rows="4" class="w-full p-3 rounded-xl border border-slate-200 bg-white/60"></textarea>
                        </div>

                        <!-- Price & Negotiation -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-bold text-slate-700 mb-2">Price (‚Çπ)</label>
                                <div class="flex items-center gap-2">
                                    <input id="item-price" class="flex-1 p-3 rounded-xl border border-slate-200 bg-white/60 focus:outline-none" placeholder="e.g. 1500 or FREE">
                                    <button type="button" id="suggested-price-btn" class="px-3 py-2 rounded-lg bg-emerald-50 text-emerald-700 font-bold text-sm hover:bg-emerald-100">‚ú® AI Price Estimator</button>
                                </div>
                                <label class="flex items-center gap-3 mt-2"><input id="open-to-negotiation" type="checkbox"> Open to Negotiation</label>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Attach image (optional)</label>
                                <input id="item-image" type="file" accept="image/*" class="w-full text-sm text-slate-600">
                                <img id="image-preview" src="" class="mt-3 w-36 h-24 object-cover rounded-lg hidden" alt="preview">
                            </div>
                        </div>

                        <!-- Salvageable Parts (shown when condition=dead) -->
                        <div id="salvage-section" class="hidden p-4 rounded-lg bg-slate-50 border border-slate-100">
                            <div class="text-sm font-bold text-slate-800 mb-2">Salvageable Parts</div>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2"><input type="checkbox" name="salvage" value="Screen"> Screen</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="salvage" value="Battery"> Battery</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="salvage" value="Keyboard"> Keyboard</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="salvage" value="Motherboard"> Motherboard</label>
                                <label class="flex items-center gap-2"><input type="checkbox" name="salvage" value="Ports"> Ports</label>
                            </div>
                        </div>

                        <!-- Data Privacy -->
                        <div class="pt-2">
                            <label class="flex items-start gap-3">
                                <input id="data-wipe" type="checkbox" class="mt-1">
                                <div class="text-sm">
                                    <div class="font-bold">I certify that I have wiped my personal data.</div>
                                    <div class="text-xs text-slate-500"> <a href="#" onclick="showDataWipeGuide(); return false;" class="underline">View Data Wipe Guide</a></div>
                                </div>
                            </label>
                        </div>

                        <div class="pt-2">
                            <button type="submit" class="w-full py-3 rounded-2xl bg-emerald-600 text-white font-bold btn-tactile shadow-lg">Post Listing</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
        </div>
    </section>

    <!-- PROFILE / IMPACT -->
    <section id="view-profile" class="hidden min-h-screen flex items-start justify-center p-6">
        <div class="max-w-4xl w-full">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-extrabold text-slate-900">My Profile</h2>
                <button onclick="goBack()" class="text-slate-600">‚Üê Back</button>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-4">
                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Radha" class="w-16 h-16 rounded-full">
                    <div class="flex-1">
                        <h3 class="text-xl font-bold text-slate-900">Radha Joshi</h3>
                        <div class="text-sm text-slate-500 flex items-center gap-2">
                            <span>‚úì Verified Member</span>
                        </div>
                    </div>
                </div>
            </div>

                <div class="flex gap-3 mb-6">
                <button id="tab-listings" onclick="switchTab('listings')" class="px-6 py-2 rounded-xl font-bold text-slate-700 hover:bg-slate-100">üì¶ My Listings</button>
                <button id="tab-history" onclick="switchTab('history')" class="px-6 py-2 rounded-xl font-bold text-slate-700 hover:bg-slate-100">üõí Purchase History</button>
            </div>

            <!-- Tab: My Listings -->
            <div id="tab-content-listings" class="hidden">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Items you've listed</h3>
                <div id="my-listings-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <!-- Tab: Purchase History -->
            <div id="tab-content-history" class="hidden">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Your purchases</h3>
                <div id="purchase-history-list" class="space-y-3"></div>
            </div>
        </div>
    </section>

    <!-- RECYCLER PICKUP MODAL (Two Views: Booking & Success/Chat) -->
    <div id="recycler-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="glass rounded-2xl p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
            <!-- View 1: Booking Form -->
            <div id="recycler-view-booking" class="space-y-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-slate-900">Schedule Recycler Pickup</h2>
                    <button onclick="closeRecyclerModal()" class="text-slate-400 hover:text-slate-900">‚úï</button>
                </div>

                <!-- Recycler Selection Cards -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">Select a Recycler</label>
                    <div id="recycler-cards-container" class="space-y-3"></div>
                </div>

                <!-- Date & Time -->
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Pickup Date</label>
                        <input id="pickup-date-input" type="date" class="w-full p-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">Preferred Time</label>
                        <select id="pickup-time-select" class="w-full p-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                            <option>9:00 AM - 12:00 PM</option>
                            <option>12:00 PM - 3:00 PM</option>
                            <option>3:00 PM - 6:00 PM</option>
                            <option>6:00 PM - 9:00 PM</option>
                        </select>
                    </div>
                </div>

                <!-- Confirm Button -->
                <button onclick="confirmPickup()" class="w-full py-3 rounded-2xl bg-emerald-600 text-white font-bold btn-tactile shadow-lg hover:bg-emerald-700">Confirm Pickup</button>
                <button onclick="closeRecyclerModal()" class="w-full py-2 rounded-lg bg-slate-100 text-slate-700 font-bold hover:bg-slate-200">Cancel</button>
            </div>

            <!-- View 2: Success & Chat -->
            <div id="recycler-view-success" class="hidden space-y-4">
                <!-- Success Message -->
                <div class="text-center py-4">
                    <div class="text-6xl mb-3">‚úÖ</div>
                    <h2 class="text-2xl font-bold text-slate-900">Pickup Scheduled!</h2>
                    <p class="text-slate-600 mt-2">with <span id="success-recycler-name" class="font-bold"></span></p>
                    <div class="mt-4 p-4 bg-emerald-50 rounded-lg border border-emerald-200">
                        <div class="text-sm text-emerald-800">
                            <div>üìÖ <span id="success-date"></span></div>
                            <div>‚è∞ <span id="success-time"></span></div>
                            <div>üìç <span id="success-distance"></span> km away</div>
                        </div>
                    </div>
                </div>

                <!-- Chat Button -->
                <button onclick="openChat()" class="w-full py-3 rounded-2xl bg-blue-600 text-white font-bold btn-tactile shadow-lg hover:bg-blue-700">üí¨ Chat with Driver</button>

                <!-- Chat Box (Hidden by default) -->
                <div id="chat-box" class="hidden mt-4 p-4 rounded-lg bg-slate-50 border border-slate-200 space-y-3">
                    <!-- Chat History -->
                    <div id="chat-history" class="space-y-2 max-h-48 overflow-y-auto bg-white rounded-lg p-3">
                        <div class="flex gap-2">
                            <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-white text-xs font-bold">D</div>
                            <div class="bg-emerald-50 rounded-lg p-2 max-w-xs">
                                <div class="text-sm text-slate-800">Hello! I'm on my way to you.</div>
                                <div class="text-xs text-slate-500 mt-1">9:15 AM</div>
                            </div>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="flex gap-2">
                        <input id="chat-input" type="text" placeholder="Type a message..." class="flex-1 p-2 rounded-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        <button onclick="sendChatMessage()" class="px-4 py-2 rounded-lg bg-emerald-600 text-white font-bold hover:bg-emerald-700">Send</button>
                    </div>
                </div>

                <!-- Done Button -->
                <button onclick="closeRecyclerModal()" class="w-full py-2 rounded-lg bg-slate-800 text-white font-bold hover:bg-slate-900">Done</button>
            </div>
        </div>
    </div>

    <!-- PROFILE / IMPACT MODAL -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-black/40 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="glass rounded-2xl p-6 max-w-md w-full max-h-screen overflow-y-auto" role="dialog" aria-modal="true">
            <div class="flex items-center justify-between mb-4">
                <div>
                    <div id="modal-user-name" class="text-lg font-bold text-slate-900">Radha Joshi - 2nd Year CS</div>
                    <div id="modal-user-college" class="text-xs text-slate-500">VNIT Nagpur</div>
                </div>
                <button onclick="closeProfileModal()" class="text-slate-400 hover:text-slate-900">‚úï</button>
            </div>

            <div id="modal-impact-body" class="space-y-4">
                <!-- Impact stats (moved from profile view) -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-sm text-slate-500">Green Points</div>
                        <div id="modal-stat-points" class="text-2xl font-extrabold text-emerald-600 mt-2">1,250</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-sm text-slate-500">CO‚ÇÇ Prevented</div>
                        <div id="modal-stat-co2" class="text-2xl font-extrabold text-slate-800 mt-2">12 kg</div>
                    </div>
                    <div class="glass rounded-2xl p-4 text-center">
                        <div class="text-sm text-slate-500">Community Rank</div>
                        <div id="modal-stat-rank" class="text-xl font-bold text-slate-700 mt-2">Silver Scavenger</div>
                    </div>
                </div>

                <div class="glass rounded-2xl p-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="text-sm font-bold text-slate-700">Progress to Gold</div>
                        <div id="modal-progress-label" class="text-xs text-slate-500">45%</div>
                    </div>
                    <div class="w-full bg-slate-100 rounded-full h-3 overflow-hidden">
                        <div id="modal-progress-bar" class="h-3 bg-emerald-500 rounded-full" style="width:45%"></div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <button onclick="doLogout()" class="w-full py-3 rounded-2xl bg-red-600 text-white font-bold hover:bg-red-700">Log Out</button>
            </div>
        </div>
    </div>

    <!-- LEADERBOARD VIEW -->
    <section id="view-leaderboard" class="hidden min-h-screen flex items-start justify-center p-6">
        <div class="max-w-3xl w-full">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-extrabold text-slate-900">Leaderboard</h2>
                <button onclick="goBack()" class="text-slate-600">‚Üê Back to Profile</button>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Top Recyclers</h3>
                <div id="leaderboard-list" class="space-y-3"></div>
            </div>

            <div class="glass rounded-2xl p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Achievement Ranks</h3>
                <div id="ranks-list" class="space-y-2"></div>
            </div>
        </div>
    </section>

    <!-- GREEN POINTS INFO VIEW -->
    <section id="view-green-points" class="hidden min-h-screen flex items-start justify-center p-6">
        <div class="max-w-3xl w-full">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-extrabold text-slate-900">Green Points</h2>
                <button onclick="goBack()" class="text-slate-600">‚Üê Back to Profile</button>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <div class="text-center mb-6">
                    <div class="text-5xl font-extrabold text-emerald-600 mb-2" id="gp-total">1,250</div>
                    <div class="text-sm text-slate-500">Your Current Balance</div>
                </div>
                <p class="text-slate-700 leading-relaxed text-center">
                    We didn't just want a marketplace; we wanted a <strong>behavior shift</strong>. By attaching a virtual currency‚ÄîGreen Points‚Äîto every action, we gamify the tedious process of waste disposal. Users earn 50 points just for listing, which <strong>lowers the barrier to entry</strong>.
                </p>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">How You Earn Points</h3>
                <div id="points-earning" class="space-y-3">
                    <div class="flex items-start gap-3 p-3 rounded-lg bg-emerald-50">
                        <div class="text-2xl">üìù</div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-900">List an Item</div>
                            <div class="text-sm text-slate-600">+50 points per listing</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50">
                        <div class="text-2xl">üì∏</div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-900">Upload Image</div>
                            <div class="text-sm text-slate-600">+10 points per quality image</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50">
                        <div class="text-2xl">‚ôªÔ∏è</div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-900">Schedule Recycler Pickup</div>
                            <div class="text-sm text-slate-600">+30 points per completed pickup</div>
                        </div>
                    </div>
                    <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-slate-50">
                        <div class="text-2xl">üí¨</div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-900">Community Engagement</div>
                            <div class="text-sm text-slate-600">+5-20 points for helpful reviews</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="text-lg font-bold text-slate-900 mb-4">Redeem Your Points</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:bg-slate-50">
                        <div>
                            <div class="font-bold text-slate-900">Discount on Next Sale</div>
                            <div class="text-xs text-slate-500">500 points</div>
                        </div>
                        <button class="px-3 py-1 rounded-lg bg-emerald-600 text-white text-sm font-bold">Redeem</button>
                    </div>
                    <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:bg-slate-50">
                        <div>
                            <div class="font-bold text-slate-900">Featured Listing Badge</div>
                            <div class="text-xs text-slate-500">750 points</div>
                        </div>
                        <button class="px-3 py-1 rounded-lg bg-emerald-600 text-white text-sm font-bold">Redeem</button>
                    </div>
                    <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:bg-slate-50">
                        <div>
                            <div class="font-bold text-slate-900">Plant a Tree (IRL)</div>
                            <div class="text-xs text-slate-500">1000 points</div>
                        </div>
                        <button class="px-3 py-1 rounded-lg bg-emerald-600 text-white text-sm font-bold">Redeem</button>
                    </div>
                </div>
            </div>

            <div class="glass rounded-2xl p-6">
                <h3 class="text-lg font-bold text-slate-900 mb-3">Impact Summary</h3>
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 rounded-lg bg-slate-50">
                        <div class="text-sm text-slate-500">Items Listed</div>
                        <div class="text-2xl font-bold text-slate-900 mt-1">25</div>
                    </div>
                    <div class="p-3 rounded-lg bg-slate-50">
                        <div class="text-sm text-slate-500">Total Earned</div>
                        <div class="text-2xl font-bold text-emerald-600 mt-1">1,250</div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- SELLER PROFILE VIEW -->
    <section id="view-seller" class="hidden min-h-screen flex items-start justify-center p-6">
        <div class="max-w-3xl w-full">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-extrabold text-slate-900">Seller Profile</h2>
                <button onclick="goBack()" class="text-slate-600">‚Üê Back</button>
            </div>

            <div class="glass rounded-2xl p-6 mb-6">
                <div class="flex items-start gap-4">
                    <img id="seller-avatar" src="" class="w-16 h-16 rounded-full">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 id="seller-name" class="text-xl font-bold text-slate-900"></h3>
                            <span id="seller-verified" class="text-xs px-2 py-1 rounded-full bg-blue-100 text-blue-700 font-bold hidden">‚úì Verified Student</span>
                        </div>
                        <div class="flex items-center gap-4 mt-3 flex-wrap">
                            <div>
                                <div class="text-sm text-slate-500">Rating</div>
                                <div id="seller-rating" class="font-bold text-slate-900">‚≠ê 4.8/5</div>
                            </div>
                            <div>
                                <div class="text-sm text-slate-500">Reviews</div>
                                <div id="seller-reviews" class="font-bold text-slate-900">45</div>
                            </div>
                            <div>
                                <div class="text-sm text-slate-500">Green Points</div>
                                <div id="seller-points" class="font-bold text-emerald-600">5,200</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <h3 class="text-lg font-bold text-slate-900 mb-4">Active Listings</h3>
            <div id="seller-items-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6"></div>

            <h3 class="text-lg font-bold text-slate-900 mb-4">Recent Reviews</h3>
            <div id="seller-reviews-list" class="space-y-3"></div>
        </div>
    </section>

    <script>
        // App state
        const VIEWS = ['view-login','view-dashboard','view-form','view-profile','view-details','view-leaderboard','view-green-points','view-seller'];

        // Users array
        const users = [
            { id: 1, name: 'You (Radha)', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Radha', greenPoints: 1250, isVerified: true, rating: 4.8, reviews: ['Great service!', 'Fast pickup!', 'Highly recommend', 'Professional handling', 'Best recycler in town'], isMe: true },
            { id: 2, name: 'EcoTech Solutions', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=EcoTech', greenPoints: 5200, isVerified: true, rating: 4.9, reviews: ['Excellent items, well-tested', 'Fair pricing and honest descriptions', 'Great communication throughout', 'Packaging was pristine', 'Purchased 3 items, all perfect'] },
            { id: 3, name: 'GreenCycle Nagpur', avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=GreenCycle', greenPoints: 3800, isVerified: true, rating: 4.7, reviews: ['Reliable seller', 'Items as described', 'Fast delivery options', 'Good customer service', 'Honest about item conditions'] }
        ];

        // Sample dynamic items (include image URLs + sellerId + pricing)
        const wasteItems = [
            { id:1, title:'Fried GPU (GTX 970)', condition:'dead', price:0, category:'pccomponent', location:'Main Campus', desc:'Heavily fried, fan seized. Good for parts (VRAM, capacitors).', image:'https://picsum.photos/seed/gpu/800/600', sellerId: 2 },
            { id:2, title:'Broken Monitor 22" Dell', condition:'partial', price:800, category:'monitor', location:'Main Campus', desc:'Cracked bezel, display has some dead pixels.', image:'https://picsum.photos/seed/monitor/800/600', sellerId: 3 },
            { id:3, title:'Old Nokia 3310', condition:'works', price:300, category:'phone', location:'Girls Hostel', desc:'Classic, battery holds charge. Good for collectors.', image:'https://picsum.photos/seed/nokia/800/600', sellerId: 2 },
            { id:4, title:'Laptop Battery (x2)', condition:'dead', price:0, category:'accessory', location:'IT Park', desc:'Swollen cells. Dispose safely ‚Äî see safety notes.', image:'https://picsum.photos/seed/battery/800/600', sellerId: 1 },
            { id:5, title:'Defunct DSLR Canon EOS', condition:'partial', price:2500, category:'accessory', location:'Civil Lines', desc:'Shutter stuck, lens fine. Great for parts or repair.', image:'https://picsum.photos/seed/dslr/800/600', sellerId: 3 },
            { id:6, title:'Dead Smartphone (Water Damaged)', condition:'dead', price:0, category:'phone', location:'Main Campus', desc:'Power circuit fried; salvageable for ICs and camera.', image:'https://picsum.photos/seed/phone/800/600', sellerId: 1 },
            { id:7, title:'Broken MacBook Air 2013', condition:'partial', price:5500, category:'laptop', location:'Main Campus', desc:'Screen works, keyboard damaged, battery dead. Good for parts.', image:'https://picsum.photos/seed/laptop1/800/600', sellerId: 2 },
            { id:8, title:'LAN Cables Bundle (10pcs)', condition:'works', price:150, category:'accessory', location:'Hostels', desc:'Cat5e ethernet cables, various lengths, tested.', image:'https://picsum.photos/seed/cables/800/600', sellerId: 1 },
            { id:9, title:'Old Breadboard & Components', condition:'works', price:200, category:'pccomponent', location:'Girls Hostel', desc:'Arduino breadboards, resistors, LED kit. Good for learning.', image:'https://picsum.photos/seed/breadboard/800/600', sellerId: 3 },
            { id:10, title:'Fried Arduino Board', condition:'dead', price:0, category:'pccomponent', location:'IT Park', desc:'Burnt components, but casing intact. Salvage chips.', image:'https://picsum.photos/seed/arduino/800/600', sellerId: 2 },
            { id:11, title:'Monitor with Lines on Screen', condition:'partial', price:600, category:'monitor', location:'Civil Lines', desc:'24" LG, vertical lines but mostly functional.', image:'https://picsum.photos/seed/monitor2/800/600', sellerId: 1 },
            { id:12, title:'iPhone 6S (Cracked Screen)', condition:'partial', price:3500, category:'phone', location:'Main Campus', desc:'Works fine, just needs screen replacement.', image:'https://picsum.photos/seed/iphone/800/600', sellerId: 3 },
            { id:13, title:'HP Pavilion Laptop (Non-Starting)', condition:'dead', price:1200, category:'laptop', location:'Hostels', desc:'Powers on but no display. Logic board issue.', image:'https://picsum.photos/seed/laptop2/800/600', sellerId: 2 },
            { id:14, title:'USB Charging Cables (20pcs bulk)', condition:'works', price:400, category:'accessory', location:'Main Campus', desc:'Micro USB, Type-C, Lightning mix. Wholesale lot.', image:'https://picsum.photos/seed/usb/800/600', sellerId: 1 },
            { id:15, title:'Broken Wireless Mouse & Keyboard', condition:'partial', price:250, category:'accessory', location:'Girls Hostel', desc:'Logitech set, mouse works, keyboard keys stuck.', image:'https://picsum.photos/seed/keyboard/800/600', sellerId: 3 },
            { id:16, title:'DDR4 RAM (16GB) - Single Stick', condition:'works', price:2800, category:'pccomponent', location:'IT Park', desc:'Corsair Vengeance, fully tested, working condition.', image:'https://picsum.photos/seed/ram/800/600', sellerId: 2 },
            { id:17, title:'Samsung SSD 256GB (Slow)', condition:'partial', price:1500, category:'pccomponent', location:'Civil Lines', desc:'Works but slow. Might have bad sectors.', image:'https://picsum.photos/seed/ssd/800/600', sellerId: 1 },
            { id:18, title:'Old Desktop Tower (No HDD)', condition:'dead', price:800, category:'accessory', location:'Main Campus', desc:'Dell OptiPlex, no hard drive, missing side panel.', image:'https://picsum.photos/seed/desktop/800/600', sellerId: 3 },
            { id:19, title:'Broken Tablet - iPad 5th Gen', condition:'partial', price:4000, category:'phone', location:'Hostels', desc:'Screen cracked, logic board intact, no charger.', image:'https://picsum.photos/seed/ipad/800/600', sellerId: 2 },
            { id:20, title:'Thunderbolt to USB Adapter Pack', condition:'works', price:600, category:'accessory', location:'Girls Hostel', desc:'Apple & 3rd party adapters, various types, tested.', image:'https://picsum.photos/seed/adapter/800/600', sellerId: 1 }
        ];

        // Render items into grid
        function renderItems(itemsToRender = wasteItems){
            const grid = document.getElementById('items-grid');
            const emptyState = document.getElementById('empty-state');
            
            if(!itemsToRender || itemsToRender.length === 0){
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            grid.innerHTML = itemsToRender.map(item => {
                const seller = users.find(u => u.id === item.sellerId);
                const priceDisplay = item.price === 0 ? 'Free' : `‚Çπ${item.price}`;
                return `
                <article class="glass rounded-2xl p-0 overflow-hidden">
                    <div class="h-44 w-full overflow-hidden">
                        <img src="${item.image || 'https://picsum.photos/seed/placeholder/800/600'}" alt="${item.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-3">
                            <span class="text-xs font-bold px-2 py-1 rounded-full ${item.condition==='dead'? 'bg-red-100 text-red-700' : item.condition==='partial'? 'bg-yellow-50 text-yellow-700' : 'bg-emerald-50 text-emerald-700'}">${item.condition==='dead'? 'Dead / Scrap' : item.condition==='partial'? 'Partially Broken' : 'Works Fine'}</span>
                            <span class="font-bold text-slate-800">${priceDisplay}</span>
                        </div>
                        <h3 class="font-bold text-lg text-slate-900 mb-1">${item.title}</h3>
                        <p class="text-sm text-slate-500 mb-3">${item.desc}</p>
                        <div class="flex items-center justify-between gap-3 mb-3">
                            <div class="text-xs text-slate-500">${item.location}</div>
                            <button onclick="openDetail(${item.id})" class="px-3 py-2 rounded-lg bg-white/50 border border-slate-100 text-sm font-medium hover:bg-slate-50">View</button>
                        </div>
                        <div class="text-xs text-slate-600 p-2 rounded bg-slate-50">Seller: ${seller ? seller.name : 'Unknown'}</div>
                    </div>
                </article>
            `;
            }).join('');
        }

        // Filter logic
        function applyFilters(){
            let filtered = [...wasteItems];
            
            // Apply search filter (from searchInput)
            const searchTerm = document.getElementById('searchInput')?.value.toLowerCase() || '';
            if(searchTerm){
                filtered = filtered.filter(item =>
                    item.title.toLowerCase().includes(searchTerm) ||
                    item.desc.toLowerCase().includes(searchTerm)
                );
            }
            
            // Apply price filter
            const minPrice = parseFloat(document.getElementById('filter-price-min')?.value) || 0;
            const maxPrice = parseFloat(document.getElementById('filter-price-max')?.value) || Infinity;
            filtered = filtered.filter(item => item.price >= minPrice && item.price <= maxPrice);
            
            // Apply location filter
            const location = document.getElementById('filter-location')?.value || '';
            if(location){
                filtered = filtered.filter(item => item.location === location);
            }
            
            // Apply condition filter
            const condition = document.getElementById('filter-condition')?.value || '';
            if(condition){
                filtered = filtered.filter(item => item.condition === condition);
            }
            
            // Apply sorting
            const sortBy = document.getElementById('filter-sort')?.value || 'newest';
            if(sortBy === 'price-asc'){
                filtered.sort((a, b) => a.price - b.price);
            } else if(sortBy === 'price-desc'){
                filtered.sort((a, b) => b.price - a.price);
            } else {
                filtered.sort((a, b) => b.id - a.id); // newest (by id)
            }
            
            // Update active filters display
            updateActiveFilters();
            
            // Render filtered items
            renderItems(filtered);
        }
        
        function updateActiveFilters(){
            const container = document.getElementById('active-filters');
            const filters = [];
            
            const minPrice = document.getElementById('filter-price-min')?.value;
            const maxPrice = document.getElementById('filter-price-max')?.value;
            if(minPrice || maxPrice){
                filters.push(`‚Çπ${minPrice || '0'} - ‚Çπ${maxPrice || '‚àû'}`);
            }
            
            const location = document.getElementById('filter-location')?.value;
            if(location) filters.push(location);
            
            const condition = document.getElementById('filter-condition')?.value;
            if(condition){
                const conditionLabels = { 'works': 'Working', 'partial': 'Repairable', 'dead': 'Scrap' };
                filters.push(conditionLabels[condition]);
            }
            
            if(filters.length > 0){
                container.innerHTML = filters.map(f => 
                    `<span class="px-3 py-1 bg-emerald-100 text-emerald-700 text-xs font-semibold rounded-full flex items-center gap-1">
                        ${f}
                        <button onclick="applyFilters()" class="ml-1 text-emerald-600 hover:text-emerald-800">‚úï</button>
                    </span>`
                ).join('');
            } else {
                container.innerHTML = '';
            }
        }
        
        function resetFilters(){
            document.getElementById('filter-price-min').value = '';
            document.getElementById('filter-price-max').value = '';
            document.getElementById('filter-location').value = '';
            document.getElementById('filter-condition').value = '';
            document.getElementById('filter-sort').value = 'newest';
            applyFilters();
        }

        // Mobile menu toggles
        function toggleMobileMenu(){
            const el = document.getElementById('mobile-menu');
            if(!el) return;
            el.classList.toggle('hidden');
        }

        function closeMobileMenu(){
            const el = document.getElementById('mobile-menu');
            if(!el) return;
            el.classList.add('hidden');
        }

        // Close mobile menu when viewport becomes desktop-sized
        window.addEventListener('resize', function(){
            if(window.innerWidth >= 768) closeMobileMenu();
        });

        // Profile modal handling
        function openProfileModal(){
            const modal = document.getElementById('profile-modal');
            if(!modal) return;
            // populate with current user data
            const me = users.find(u=>u.isMe) || users[0];
            document.getElementById('modal-user-name').textContent = `${me.name} - 2nd Year CS`;
            document.getElementById('modal-user-college').textContent = me.college || 'VNIT Nagpur';
            document.getElementById('modal-stat-points').textContent = me.greenPoints?.toLocaleString() || '0';
            // sample values for CO2 and rank (could be computed)
            document.getElementById('modal-stat-co2').textContent = window.statCO2 || '12 kg';
            document.getElementById('modal-stat-rank').textContent = window.statRank || 'Silver Scavenger';
            document.getElementById('modal-progress-label').textContent = window.statProgressLabel || '45%';
            document.getElementById('modal-progress-bar').style.width = (window.statProgressPercent || 45) + '%';
            modal.classList.remove('hidden');
        }

        function closeProfileModal(){
            const modal = document.getElementById('profile-modal');
            if(!modal) return;
            modal.classList.add('hidden');
        }

        // Close profile modal on outside click
        document.addEventListener('click', function(e){
            const modal = document.getElementById('profile-modal');
            if(!modal || modal.classList.contains('hidden')) return;
            const dialog = modal.querySelector('[role="dialog"]');
            if(dialog && !dialog.contains(e.target)) closeProfileModal();
        });

        // Close profile modal on Escape
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeProfileModal(); });

        // open detail view and populate fields
        function openDetail(id){
            const it = wasteItems.find(x=>x.id===id);
            if(!it) return;
            const seller = users.find(u => u.id === it.sellerId);
            document.getElementById('detail-title').textContent = it.title;
            const priceDisplay = it.price === 0 ? 'Free' : `‚Çπ${it.price}`;
            document.getElementById('detail-price').textContent = priceDisplay;
            document.getElementById('detail-condition').textContent = it.condition==='dead'? 'Dead / Scrap' : it.condition==='partial'? 'Partially Broken' : 'Works Fine';
            document.getElementById('detail-desc').textContent = it.desc;
            
            // Seller card
            if(seller){
                document.getElementById('detail-seller-avatar').src = seller.avatar;
                document.getElementById('detail-seller-name').textContent = seller.name;
                document.getElementById('detail-seller-rating').textContent = `‚≠ê ${seller.rating}/5 (${seller.reviews} reviews)`;
            }
            
            // Set current item and seller for later use
            window.currentDetailItem = it;
            window.currentDetailSeller = seller;
            
            // Show/hide buttons based on price
            const buyBtn = document.getElementById('btn-buy');
            const pickupLink = document.getElementById('pickup-link');
            if(it.price === 0){
                buyBtn.textContent = 'üÜì Claim for Free';
            } else {
                buyBtn.textContent = 'üí≥ Buy Now';
            }
            
            // Show pickup link for dead items
            if(it.condition === 'dead'){
                pickupLink.classList.remove('hidden');
            } else {
                pickupLink.classList.add('hidden');
            }
            
            // Store for back button
            window.previousView = 'view-dashboard';
            showView('view-details');
        }

        // Recycler pickup flow
        function openPickup(){
            openRecyclerModal();
        }

        // Recycler data
        const recyclers = [
            { id: 1, name: 'Eco-Nagpur Recyclers', distance: 0.8, rating: 4.9, reviews: 127 },
            { id: 2, name: 'GreenCycle Solutions', distance: 2.5, rating: 4.7, reviews: 94 },
            { id: 3, name: 'Tech Waste Management', distance: 3.2, rating: 4.6, reviews: 78 },
            { id: 4, name: 'Sustainable Recyclers Co.', distance: 4.1, rating: 4.8, reviews: 156 },
            { id: 5, name: 'Metro E-Waste Disposal', distance: 5.3, rating: 4.5, reviews: 62 }
        ].sort((a, b) => a.distance - b.distance); // Sort by distance

        let selectedRecyclerId = recyclers[0].id; // Pre-select closest

        // Open recycler modal and populate cards
        function openRecyclerModal(){
            selectedRecyclerId = recyclers[0].id;
            const container = document.getElementById('recycler-cards-container');
            container.innerHTML = recyclers.map((r, idx) => `
                <label class="flex items-center gap-3 p-4 rounded-lg border-2 ${ idx === 0 ? 'border-emerald-600 bg-emerald-50' : 'border-slate-200 hover:border-slate-300'} cursor-pointer transition">
                    <input type="radio" name="recycler" value="${r.id}" ${ idx === 0 ? 'checked' : ''} onchange="selectedRecyclerId = ${r.id}" class="accent-emerald-600">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <div class="font-bold text-slate-900">${r.name}</div>
                            ${ idx === 0 ? '<span class="text-xs px-2 py-1 rounded-full bg-emerald-600 text-white font-bold">üèÜ Best Match / Closest</span>' : ''}
                        </div>
                        <div class="text-sm text-slate-600 mt-1">‚≠ê ${r.rating}/5 (${r.reviews} reviews) ‚Ä¢ üìç ${r.distance} km away</div>
                    </div>
                </label>
            `).join('');

            // Set default date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            document.getElementById('pickup-date-input').value = tomorrow.toISOString().split('T')[0];
            document.getElementById('pickup-date-input').min = tomorrow.toISOString().split('T')[0];

            // Show booking view
            document.getElementById('recycler-view-booking').classList.remove('hidden');
            document.getElementById('recycler-view-success').classList.add('hidden');
            document.getElementById('recycler-modal').classList.remove('hidden');
        }

        function confirmPickup(){
            const date = document.getElementById('pickup-date-input').value;
            const time = document.getElementById('pickup-time-select').value;
            if(!date) { alert('Please select a date'); return; }

            const recycler = recyclers.find(r => r.id === selectedRecyclerId);
            document.getElementById('success-recycler-name').textContent = recycler.name;
            document.getElementById('success-date').textContent = new Date(date).toLocaleDateString('en-IN', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
            document.getElementById('success-time').textContent = time;
            document.getElementById('success-distance').textContent = recycler.distance;

            // Switch to success view
            document.getElementById('recycler-view-booking').classList.add('hidden');
            document.getElementById('recycler-view-success').classList.remove('hidden');
            document.getElementById('chat-box').classList.add('hidden');
            document.getElementById('chat-input').value = '';
        }

        function openChat(){
            document.getElementById('chat-box').classList.remove('hidden');
            document.getElementById('chat-input').focus();
        }

        function sendChatMessage(){
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if(!msg) return;

            const history = document.getElementById('chat-history');
            const time = new Date().toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
            const userMsg = `
                <div class="flex gap-2 justify-end">
                    <div class="bg-emerald-600 text-white rounded-lg p-2 max-w-xs">
                        <div class="text-sm">${msg}</div>
                        <div class="text-xs text-emerald-100 mt-1">${time}</div>
                    </div>
                </div>
            `;
            history.innerHTML += userMsg;
            input.value = '';
            history.scrollTop = history.scrollHeight;

            // Simulate driver response
            setTimeout(() => {
                const driverTime = new Date().toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
                const driverMsg = `
                    <div class="flex gap-2">
                        <div class="w-8 h-8 rounded-full bg-emerald-600 flex items-center justify-center text-white text-xs font-bold">D</div>
                        <div class="bg-emerald-50 rounded-lg p-2 max-w-xs">
                            <div class="text-sm text-slate-800">Got it! See you soon.</div>
                            <div class="text-xs text-slate-500 mt-1">${driverTime}</div>
                        </div>
                    </div>
                `;
                history.innerHTML += driverMsg;
                history.scrollTop = history.scrollHeight;
            }, 800);
        }

        function closeRecyclerModal(){
            document.getElementById('recycler-modal').classList.add('hidden');
        }

        // Leaderboard data
        const dummyLeaderboard = [
            { rank: 1, name: 'Eco Warrior', points: 3200, avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=EcoW' },
            { rank: 2, name: 'Recycle King', points: 2850, avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=RecK' },
            { rank: 3, name: 'You', points: 1250, avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Radha', isYou: true },
            { rank: 4, name: 'Green Guardian', points: 1100, avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=GreenG' },
            { rank: 5, name: 'Tech Lover', points: 980, avatar: 'https://api.dicebear.com/7.x/avataaars/svg?seed=TechL' }
        ];

        const ranks = [
            { name: 'Bronze Scavenger', points: 500, icon: 'ü•â' },
            { name: 'Silver Tinkerer', points: 1000, icon: 'ü•à' },
            { name: 'Gold Guardian', points: 2000, icon: 'ü•á' },
            { name: 'Platinum Pioneer', points: 3500, icon: 'üíé' }
        ];

        // populate leaderboard
        function populateLeaderboard(){
            const list = document.getElementById('leaderboard-list');
            const userPoints = parseInt(document.getElementById('stat-points').textContent.replace(/,/g,''));
            list.innerHTML = dummyLeaderboard.map((u, i) => `
                <div class="flex items-center gap-3 p-3 rounded-lg ${u.isYou? 'bg-emerald-50 border border-emerald-200' : 'hover:bg-slate-50'}">
                    <div class="font-bold text-slate-500 w-6 text-center">#${u.rank}</div>
                    <img src="${u.avatar}" class="w-10 h-10 rounded-full">
                    <div class="flex-1">
                        <div class="font-bold text-slate-900">${u.name}</div>
                        <div class="text-xs text-slate-500">${u.points.toLocaleString()} points</div>
                    </div>
                    ${u.isYou? '<div class="text-xs px-2 py-1 rounded bg-emerald-200 text-emerald-800 font-bold">YOU</div>' : ''}
                </div>
            `).join('');

            const ranksList = document.getElementById('ranks-list');
            ranksList.innerHTML = ranks.map(r => {
                const isCurrent = userPoints >= r.points && (ranks.indexOf(r) === ranks.length - 1 || userPoints < ranks[ranks.indexOf(r)+1].points);
                return `
                    <div class="flex items-center gap-3 p-3 rounded-lg ${isCurrent? 'bg-emerald-50 border border-emerald-300' : 'hover:bg-slate-50'}">
                        <div class="text-2xl">${r.icon}</div>
                        <div class="flex-1">
                            <div class="font-bold text-slate-900">${r.name}</div>
                            <div class="text-xs text-slate-500">${r.points.toLocaleString()} points required</div>
                        </div>
                        ${isCurrent? '<div class="text-xs px-2 py-1 rounded bg-emerald-200 text-emerald-800 font-bold">CURRENT</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // Navigation history stack
        let navHistory = [];
        window.currentView = null;

        // Centralized view switcher. If isBackNavigation is true, the switch won't push current view into history.
        function switchView(viewId, isBackNavigation = false){
            try{
                // push current view to history unless this navigation is a back action
                if(!isBackNavigation && window.currentView && window.currentView !== viewId){
                    navHistory.push(window.currentView);
                }

                // hide all and show target
                VIEWS.forEach(v => document.getElementById(v).classList.add('hidden'));
                const target = document.getElementById(viewId);
                if(target) target.classList.remove('hidden');
                if(target) target.classList.add('fade-in');

                // Show navbar for all views except login
                const navbar = document.getElementById('global-navbar');
                if(viewId === 'view-login'){
                    navbar.classList.add('hidden');
                } else {
                    navbar.classList.remove('hidden');
                }

                // update currentView tracker
                window.currentView = viewId;

                // Update navbar active state
                updateNavState(viewId);

                // special hooks
                if(viewId === 'view-dashboard') renderItems();
                if(viewId === 'view-profile') { updateProfileStats(); populateLeaderboard(); }
                if(viewId === 'view-leaderboard') populateLeaderboard();
                if(viewId === 'view-form') showCategoryGrid();
            }catch(e){ console.error('switchView error', e); }
        }

        // Update navbar active state based on current view
        function updateNavState(viewId){
            // Map views to nav button IDs
            const navMap = {
                'view-dashboard': 'nav-dashboard',
                'view-form': 'nav-sell',
                //'view-profile': 'nav-impact' // profile doesn't have a dedicated nav link now
            };

            // Active style classes
            const activeClass = 'text-emerald-600 border-b-emerald-600';
            const inactiveClass = 'text-slate-700';

            // Remove active state from all nav links
            ['nav-dashboard', 'nav-sell'].forEach(id => {
                const el = document.getElementById(id);
                if(el){
                    el.classList.remove(...activeClass.split(' '));
                    el.classList.add(...inactiveClass.split(' '));
                }
            });

            // Add active state to current view's nav link
            const navId = navMap[viewId];
            if(navId){
                const el = document.getElementById(navId);
                if(el){
                    el.classList.remove(...inactiveClass.split(' '));
                    el.classList.add(...activeClass.split(' '));
                }
            }
        }

        // Back navigation: pop last view from navHistory and navigate without adding to history
        function goBack(){
            const last = navHistory.pop();
            if(last){
                switchView(last, true);
            } else {
                switchView('view-dashboard', true);
            }
        }

        // navTo clears history and navigates (used by main navbar)
        function navTo(viewId){
            navHistory = [];
            switchView(viewId, true);
        }

        // Keep old name for compatibility
        const showView = switchView;

        // Login logic (preserve credentials)
        document.getElementById('login-form').addEventListener('submit', function(e){
            e.preventDefault();
            const u = document.getElementById('username').value.trim().toLowerCase();
            const p = document.getElementById('password').value;
            const err = document.getElementById('login-error');
            if(u === 'radha' && p === 'project2026'){
                err.classList.add('hidden');
                showView('view-dashboard');
            } else {
                err.classList.remove('hidden');
                // micro shake
                const btn = document.getElementById('btn-login');
                btn.animate([{ transform: 'translateX(6px)' }, { transform: 'translateX(-6px)' }, { transform: 'none' }], { duration: 260, iterations:1 });
            }
        });

        // Logout
        function doLogout(){
            // clear inputs
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showView('view-login');
        }

        // Sell form smart logic
        const form = document.getElementById('sell-form');
        const batteryWarning = document.getElementById('battery-warning');
        const fileInput = document.getElementById('item-image');
        const previewImg = document.getElementById('image-preview');
        const proToggle = document.getElementById('pro-mode-toggle');
        const salvageSection = document.getElementById('salvage-section');
        const suggestedBtn = document.getElementById('suggested-price-btn');

        // Category-specific dynamic field templates
        const categoryTemplates = {
            smartphone: `
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Condition</label>
                    <div class="flex gap-3 text-sm mb-3">
                        <label><input type="radio" name="condition" value="works" checked> Works</label>
                        <label><input type="radio" name="condition" value="partial"> Partially Broken</label>
                        <label><input type="radio" name="condition" value="dead"> Dead / Scrap</label>
                    </div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Operating System</label>
                    <select id="field-os" class="w-full p-3 rounded-xl border border-slate-200 mb-3">
                        <option>Android</option>
                        <option>iOS</option>
                    </select>

                    <label class="block text-sm font-bold text-slate-700 mb-2">Storage Capacity</label>
                    <input id="field-storage" placeholder="e.g. 64GB, 128GB" class="w-full p-3 rounded-xl border border-slate-200 mb-3">

                    <label class="flex items-center gap-3 mb-2"><input id="field-frp" type="checkbox"> Is it Cloud / FRP Locked?</label>
                    <label class="flex items-center gap-3"><input id="field-screen-cracked" type="checkbox"> Screen Cracked?</label>
                </div>
            `,

            laptop: `
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Condition</label>
                    <div class="flex gap-3 text-sm mb-3">
                        <label><input type="radio" name="condition" value="works" checked> Works</label>
                        <label><input type="radio" name="condition" value="partial"> Partially Broken</label>
                        <label><input type="radio" name="condition" value="dead"> Dead / Scrap</label>
                    </div>

                    <label class="block text-sm font-bold text-slate-700 mb-2">Processor Model</label>
                    <input id="field-processor-model" placeholder="e.g. i5 8th Gen, M1" class="w-full p-3 rounded-xl border border-slate-200 mb-3">

                    <label class="block text-sm font-bold text-slate-700 mb-2">RAM Size</label>
                    <input id="field-ram-size" placeholder="e.g. 8GB, 16GB" class="w-full p-3 rounded-xl border border-slate-200 mb-3">

                    <div class="mb-3">
                        <div class="text-sm font-bold mb-1">Storage Type</div>
                        <label class="mr-3"><input type="radio" name="storage_type" value="HDD"> HDD</label>
                        <label class="mr-3"><input type="radio" name="storage_type" value="SSD" checked> SSD</label>
                        <label><input type="radio" name="storage_type" value="None"> None</label>
                    </div>

                    <label class="block text-sm font-bold text-slate-700 mb-2">Battery Health</label>
                    <select id="field-battery-health" class="w-full p-3 rounded-xl border border-slate-200 mb-3">
                        <option>Good</option>
                        <option>Weak</option>
                        <option>Dead</option>
                        <option>Missing</option>
                    </select>
                </div>
            `,

            monitor: `
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Condition</label>
                    <div class="flex gap-3 text-sm mb-3">
                        <label><input type="radio" name="condition" value="works" checked> Works</label>
                        <label><input type="radio" name="condition" value="partial"> Partially Broken</label>
                        <label><input type="radio" name="condition" value="dead"> Dead / Scrap</label>
                    </div>

                    <label class="block text-sm font-bold text-slate-700 mb-2">Screen Size (inches)</label>
                    <input id="field-screen-size" placeholder="e.g. 22" class="w-full p-3 rounded-xl border border-slate-200 mb-3">

                    <label class="block text-sm font-bold text-slate-700 mb-2">Panel Condition</label>
                    <select id="field-panel-condition" class="w-full p-3 rounded-xl border border-slate-200 mb-3">
                        <option>Working</option>
                        <option>Lines on Screen</option>
                        <option>Cracked</option>
                        <option>Black Screen</option>
                    </select>

                    <label class="flex items-center gap-3"><input id="field-power-cable" type="checkbox"> Includes Power Cable?</label>
                </div>
            `,

            pccomponent: `
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Condition</label>
                    <div class="flex gap-3 text-sm mb-3">
                        <label><input type="radio" name="condition" value="works" checked> Works</label>
                        <label><input type="radio" name="condition" value="partial"> Partially Broken</label>
                        <label><input type="radio" name="condition" value="dead"> Dead / Scrap</label>
                    </div>

                    <label class="block text-sm font-bold text-slate-700 mb-2">Part Name & Model</label>
                    <input id="field-part-name" placeholder="e.g. Nvidia GTX 1050Ti" class="w-full p-3 rounded-xl border border-slate-200 mb-3">

                    <label class="block text-sm font-bold text-slate-700 mb-2">Model Number</label>
                    <input id="field-model-number" placeholder="e.g. GTx-1050Ti-4GB" class="w-full p-3 rounded-xl border border-slate-200 mb-3">

                    <label class="flex items-center gap-3 mb-2"><input id="field-tested" type="checkbox"> Tested & Working?</label>

                    <label class="block text-sm font-bold text-slate-700 mb-2">Known Issues</label>
                    <textarea id="field-known-issues" rows="3" class="w-full p-3 rounded-xl border border-slate-200 mb-3" placeholder="e.g. Fan noise, overheating"></textarea>

                    <label class="block text-sm font-bold text-slate-700 mb-2">VRAM / Specs (optional)</label>
                    <input id="field-vram" placeholder="e.g. 4GB GDDR5" class="w-full p-3 rounded-xl border border-slate-200 mb-3">
                </div>
            `,

            other: `
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Condition</label>
                    <div class="flex gap-3 text-sm mb-3">
                        <label><input type="radio" name="condition" value="works" checked> New</label>
                        <label><input type="radio" name="condition" value="partial"> Used</label>
                        <label><input type="radio" name="condition" value="dead"> Frayed / Damaged</label>
                    </div>

                    <label class="block text-sm font-bold text-slate-700 mb-2">Type</label>
                    <select id="field-accessory-type" class="w-full p-3 rounded-xl border border-slate-200 mb-3">
                        <option>Charger</option>
                        <option>HDMI</option>
                        <option>Keyboard</option>
                        <option>Mouse</option>
                    </select>
                </div>
            `
        };

        // Pro-mode extra fields per category
        const proTemplates = {
            smartphone: `
                <div class="p-3 rounded-lg bg-slate-50 border border-slate-100 mb-3">
                    <label class="block text-sm font-bold text-slate-700 mb-2">IMEI / Serial (optional)</label>
                    <input id="pro-imei" class="w-full p-2 rounded-lg border border-slate-200" placeholder="e.g. 358723...">
                    <label class="flex items-center gap-3 mt-3"><input id="pro-bootloader-locked" type="checkbox"> Bootloader / BIOS Locked?</label>
                </div>
            `,
            laptop: `
                <div class="p-3 rounded-lg bg-slate-50 border border-slate-100 mb-3">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Model Number</label>
                    <input id="pro-model-number" class="w-full p-2 rounded-lg border border-slate-200" placeholder="e.g. MacBookPro15,1">
                    <label class="block text-sm font-bold text-slate-700 mb-2 mt-3">Thermal Paste Status</label>
                    <select id="pro-thermal" class="w-full p-2 rounded-lg border border-slate-200">
                        <option>Unknown</option>
                        <option>Recently Reapplied</option>
                        <option>Needs Replacing</option>
                    </select>
                    <label class="flex items-center gap-3 mt-3"><input id="pro-bios-locked" type="checkbox"> BIOS Locked?</label>
                </div>
            `,
            monitor: `
                <div class="p-3 rounded-lg bg-slate-50 border border-slate-100 mb-3">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Manufacturer Model</label>
                    <input id="pro-monitor-model" class="w-full p-2 rounded-lg border border-slate-200" placeholder="e.g. LG UltraGear 27GL83A">
                </div>
            `,
            pccomponent: `
                <div class="p-3 rounded-lg bg-slate-50 border border-slate-100 mb-3">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Detailed Part SKU / Serial</label>
                    <input id="pro-part-sku" class="w-full p-2 rounded-lg border border-slate-200" placeholder="e.g. P/N: 12345-XYZ">
                    <label class="flex items-center gap-3 mt-3"><input id="pro-tested-working" type="checkbox"> Verified bench-tested?</label>
                </div>
            `,
            other: `
                <div class="p-3 rounded-lg bg-slate-50 border border-slate-100 mb-3">
                    <label class="block text-sm font-bold text-slate-700 mb-2">Accessory Notes</label>
                    <input id="pro-accessory-notes" class="w-full p-2 rounded-lg border border-slate-200" placeholder="Brand, compatibility">
                </div>
            `
        };

        // Attach listeners to condition radios (re-run after injecting dynamic fields)
        function attachConditionListeners(){
            const conds = form.querySelectorAll('input[name="condition"]');
            conds.forEach(r => {
                r.removeEventListener('change', conditionChangeHandler);
                r.addEventListener('change', conditionChangeHandler);
            });
        }

        function conditionChangeHandler(e){
            const r = e.target;
            if(r.value === 'dead' && r.checked){
                batteryWarning.classList.remove('hidden');
                salvageSection.classList.remove('hidden');
            } else if(r.checked){
                batteryWarning.classList.add('hidden');
                salvageSection.classList.add('hidden');
            }
        }

        // collect pro-mode inputs generically
        function collectProData(){
            const container = document.getElementById('dynamic-pro-fields');
            if(!container) return null;
            const data = {};
            container.querySelectorAll('input, select, textarea').forEach(el => {
                if(!el.id) return;
                if(el.type === 'checkbox') data[el.id] = el.checked;
                else data[el.id] = el.value;
            });
            return data;
        }

        // Choose a category and render the dynamic template
        function chooseCategory(cat){
            window.selectedCategory = cat;
            const label = document.getElementById('selected-category-label');
            const friendly = ({smartphone:'Smartphone', laptop:'Laptop', monitor:'Monitor / TV', pccomponent:'PC Component', other:'Accessories / Cables'})[cat] || cat;
            label.textContent = friendly;
            document.getElementById('category-grid').classList.add('hidden');
            document.getElementById('category-form').classList.remove('hidden');
            const dyn = document.getElementById('dynamic-fields');
            dyn.innerHTML = categoryTemplates[cat] || categoryTemplates.other;
            // inject pro fields if pro mode is already on
            const proDyn = document.getElementById('dynamic-pro-fields');
            if(proDyn){
                proDyn.innerHTML = proToggle.checked ? (proTemplates[cat] || '') : '';
                proDyn.classList.toggle('hidden', !proToggle.checked);
            }
            // attach condition listeners for newly injected radios
            attachConditionListeners();
            // ensure battery warning / salvage initial state
            const sel = form.querySelector('input[name="condition"]:checked');
            if(sel && sel.value === 'dead'){
                batteryWarning.classList.remove('hidden'); salvageSection.classList.remove('hidden');
            } else {
                batteryWarning.classList.add('hidden'); salvageSection.classList.add('hidden');
            }
        }

        function changeCategory(){
            showCategoryGrid();
        }

        function showCategoryGrid(){
            document.getElementById('category-grid').classList.remove('hidden');
            document.getElementById('category-form').classList.add('hidden');
            // clear dynamic fields
            const dyn = document.getElementById('dynamic-fields'); if(dyn) dyn.innerHTML = '';
            window.selectedCategory = null;
        }

        // helper: show toast
        function showToast(message, timeout=2600){
            const t = document.createElement('div');
            t.textContent = message;
            t.className = 'fixed left-1/2 -translate-x-1/2 bottom-10 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg opacity-0';
            document.body.appendChild(t);
            requestAnimationFrame(()=> t.classList.add('opacity-100'));
            setTimeout(()=>{ t.classList.remove('opacity-100'); setTimeout(()=> t.remove(), 300); }, timeout);
        }

        // toggle tech specs (Pro Mode)
        proToggle.addEventListener('change', ()=>{
            const proDyn = document.getElementById('dynamic-pro-fields');
            if(proToggle.checked){
                if(proDyn && window.selectedCategory){ proDyn.innerHTML = proTemplates[window.selectedCategory] || ''; proDyn.classList.remove('hidden'); }
            } else {
                if(proDyn){ proDyn.innerHTML = ''; proDyn.classList.add('hidden'); }
            }
        });

        // show battery warning & salvage section when condition changes
        form.querySelectorAll('input[name="condition"]').forEach(r => {
            r.addEventListener('change', () => {
                if(r.value === 'dead' && r.checked){
                    batteryWarning.classList.remove('hidden');
                    salvageSection.classList.remove('hidden');
                } else if(r.checked){
                    batteryWarning.classList.add('hidden');
                    salvageSection.classList.add('hidden');
                }
            });
        });

        // preview selected image
        fileInput.addEventListener('change', (e) => {
            const f = e.target.files && e.target.files[0];
            if(!f) { previewImg.src = ''; previewImg.classList.add('hidden'); return; }
            const reader = new FileReader();
            reader.onload = function(evt){ previewImg.src = evt.target.result; previewImg.classList.remove('hidden'); };
            reader.readAsDataURL(f);
        });

        function readFileAsDataURL(file){
            return new Promise((res, rej) => {
                const r = new FileReader();
                r.onload = () => res(r.result);
                r.onerror = rej;
                r.readAsDataURL(file);
            });
        }

        // Suggested price logic
        function parseNumericPrice(value){
            if(!value) return 0;
            const n = (''+value).replace(/[^0-9]/g,'');
            return parseInt(n) || 0;
        }

        suggestedBtn.addEventListener('click', ()=>{
            const condEl = form.querySelector('input[name="condition"]:checked');
            const cond = condEl ? condEl.value : 'partial';
            const cat = window.selectedCategory || 'other';
            let suggested = 0;
            // Category-aware ranges
            if(cat === 'laptop'){
                if(cond === 'works') suggested = Math.round(3000 + Math.random()*12000);
                else if(cond === 'partial') suggested = Math.round(1000 + Math.random()*4000);
                else suggested = Math.round(200 + Math.random()*900);
            } else if(cat === 'smartphone'){
                if(cond === 'works') suggested = Math.round(1000 + Math.random()*8000);
                else if(cond === 'partial') suggested = Math.round(300 + Math.random()*1500);
                else suggested = Math.round(50 + Math.random()*500);
            } else if(cat === 'pccomponent'){
                if(cond === 'works') suggested = Math.round(800 + Math.random()*7000);
                else if(cond === 'partial') suggested = Math.round(200 + Math.random()*1500);
                else suggested = Math.round(20 + Math.random()*400);
            } else if(cat === 'monitor'){
                if(cond === 'works') suggested = Math.round(1200 + Math.random()*3000);
                else if(cond === 'partial') suggested = Math.round(300 + Math.random()*900);
                else suggested = Math.round(50 + Math.random()*300);
            } else {
                if(cond === 'works') suggested = Math.round(200 + Math.random()*800);
                else if(cond === 'partial') suggested = Math.round(50 + Math.random()*300);
                else suggested = Math.round(10 + Math.random()*150);
            }

            document.getElementById('item-price').value = '‚Çπ' + suggested;
            showToast('AI estimator suggests ‚Çπ' + suggested);
        });

        // Data wipe guide
        function showDataWipeGuide(){
            alert('Data Wipe Guide:\n1) Factory reset the device.\n2) Remove all accounts.\n3) Overwrite storage where possible.\n4) For phones, remove SIM/SD cards.');
        }

        // handle post (demo) ‚Äî supports optional image upload and new fields
        async function handlePost(e){
            e.preventDefault();
            const title = document.getElementById('item-title').value.trim();
            const priceRaw = document.getElementById('item-price').value.trim() || '';
            const price = priceRaw === '' ? 'Free' : priceRaw;
            const condEl = form.querySelector('input[name="condition"]:checked');
            const cond = condEl ? condEl.value : 'partial';

            // data wipe required
            if(!document.getElementById('data-wipe').checked){
                alert('Please certify that you have wiped personal data before listing.');
                return;
            }

            // category-specific fields
            const category = window.selectedCategory || 'other';
            const desc = document.getElementById('item-desc').value.trim();
            const negotiable = document.getElementById('open-to-negotiation').checked;
            const extra = {};
            if(category === 'smartphone'){
                extra.os = (document.getElementById('field-os')||{value:''}).value.trim();
                extra.storage = (document.getElementById('field-storage')||{value:''}).value.trim();
                extra.frpLocked = !!document.getElementById('field-frp') && document.getElementById('field-frp').checked;
                extra.screenCracked = !!document.getElementById('field-screen-cracked') && document.getElementById('field-screen-cracked').checked;
            } else if(category === 'laptop'){
                extra.processor = (document.getElementById('field-processor-model')||{value:''}).value.trim();
                extra.ram = (document.getElementById('field-ram-size')||{value:''}).value.trim();
                extra.storageType = document.querySelector('input[name="storage_type"]:checked')?.value || 'unknown';
                extra.batteryHealth = (document.getElementById('field-battery-health')||{value:''}).value.trim();
            } else if(category === 'monitor'){
                extra.screenSize = (document.getElementById('field-screen-size')||{value:''}).value.trim();
                extra.panelCondition = (document.getElementById('field-panel-condition')||{value:''}).value.trim();
                extra.powerCable = !!document.getElementById('field-power-cable') && document.getElementById('field-power-cable').checked;
            } else if(category === 'pccomponent'){
                extra.partName = (document.getElementById('field-part-name')||{value:''}).value.trim();
                extra.modelNumber = (document.getElementById('field-model-number')||{value:''}).value.trim();
                extra.tested = !!document.getElementById('field-tested') && document.getElementById('field-tested').checked;
                extra.knownIssues = (document.getElementById('field-known-issues')||{value:''}).value.trim();
                extra.vram = (document.getElementById('field-vram')||{value:''}).value.trim();
            } else if(category === 'other'){
                extra.accessoryType = (document.getElementById('field-accessory-type')||{value:''}).value.trim();
            }

            // collect pro-mode data if enabled
            const proData = proToggle.checked ? collectProData() : null;

            // salvage parts
            const salvage = Array.from(document.querySelectorAll('#category-form input[name="salvage"]:checked')).map(i=>i.value);

            let imageUrl = '';
            const f = fileInput.files && fileInput.files[0];
            if(f){
                try{ imageUrl = await readFileAsDataURL(f); }catch(err){ console.error(err); }
            }

            const newItem = { id: Date.now(), title, description: desc, category, condition: cond, price, negotiable, location:'Nagpur', image: imageUrl || 'https://picsum.photos/seed/new/800/600', extraFields: extra, proModeData: proData, salvageParts: salvage, dataWipeConfirmed: true, sellerId: 1 };
            wasteItems.unshift(newItem);

            // reset UI: go to dashboard and reset form
            form.reset(); previewImg.src = ''; previewImg.classList.add('hidden');
            salvageSection.classList.add('hidden'); proToggle.checked = false;
            document.getElementById('dynamic-pro-fields').innerHTML = ''; document.getElementById('dynamic-pro-fields').classList.add('hidden');
            window.selectedCategory = null;
            showToast('Listed: ' + title + ' (+50 Green Points)');

            // update points and UI
            const pts = parseInt(document.getElementById('stat-points').textContent.replace(/,/g,'')) + 50;
            document.getElementById('stat-points').textContent = pts.toLocaleString();
            const bar = document.getElementById('progress-bar');
            const current = parseFloat(bar.style.width) || 45;
            const next = Math.min(100, current + 3);
            bar.style.width = next + '%';

            switchView('view-dashboard');
            renderItems();
        }

        // Profile update demo
        function updateProfileStats(){
            // values already set in markup; in a real app we'd fetch them
        }

        // Handle search
        function handleSearch(){
            const query = document.getElementById('search-bar').value.toLowerCase().trim();
            if(!query){
                renderItems(wasteItems);
                return;
            }
            const filtered = wasteItems.filter(item => {
                const seller = users.find(u => u.id === item.sellerId);
                const sellerName = seller ? seller.name.toLowerCase() : '';
                return (
                    item.title.toLowerCase().includes(query) ||
                    item.desc.toLowerCase().includes(query) ||
                    sellerName.includes(query) ||
                    item.location.toLowerCase().includes(query)
                );
            });
            renderItems(filtered);
        }

        // Switch profile tabs
        function switchTab(tab){
            // Hide all tab contents
            const elImpact = document.getElementById('tab-content-impact');
            if(elImpact) elImpact.classList.add('hidden');
            document.getElementById('tab-content-listings').classList.add('hidden');
            document.getElementById('tab-content-history').classList.add('hidden');
            
            // Reset all tab buttons
            const tabImpactBtn = document.getElementById('tab-impact');
            if(tabImpactBtn){
                tabImpactBtn.classList.remove('bg-emerald-100', 'border-b-2', 'border-emerald-600');
                tabImpactBtn.classList.add('hover:bg-slate-100', 'text-slate-700');
            }
            document.getElementById('tab-listings').classList.remove('bg-emerald-100', 'border-b-2', 'border-emerald-600');
            document.getElementById('tab-listings').classList.add('hover:bg-slate-100', 'text-slate-700');
            document.getElementById('tab-history').classList.remove('bg-emerald-100', 'border-b-2', 'border-emerald-600');
            document.getElementById('tab-history').classList.add('hover:bg-slate-100', 'text-slate-700');
            
            // Show selected tab
            if(tab === 'impact'){
                if(elImpact){
                    elImpact.classList.remove('hidden');
                }
                if(tabImpactBtn){
                    tabImpactBtn.classList.add('bg-emerald-100', 'border-b-2', 'border-emerald-600');
                    tabImpactBtn.classList.remove('hover:bg-slate-100', 'text-slate-700');
                    tabImpactBtn.classList.add('text-slate-900');
                }
            } else if(tab === 'listings'){
                document.getElementById('tab-content-listings').classList.remove('hidden');
                document.getElementById('tab-listings').classList.add('bg-emerald-100', 'border-b-2', 'border-emerald-600');
                document.getElementById('tab-listings').classList.remove('hover:bg-slate-100', 'text-slate-700');
                document.getElementById('tab-listings').classList.add('text-slate-900');
                renderMyListings();
            } else if(tab === 'history'){
                document.getElementById('tab-content-history').classList.remove('hidden');
                document.getElementById('tab-history').classList.add('bg-emerald-100', 'border-b-2', 'border-emerald-600');
                document.getElementById('tab-history').classList.remove('hover:bg-slate-100', 'text-slate-700');
                document.getElementById('tab-history').classList.add('text-slate-900');
                renderPurchaseHistory();
            }
        }

        // Render my listings
        function renderMyListings(){
            const myItems = wasteItems.filter(item => item.sellerId === 1);
            const grid = document.getElementById('my-listings-grid');
            if(myItems.length === 0){
                grid.innerHTML = '<div class="col-span-2 text-center p-8 text-slate-500">You haven\'t listed any items yet.</div>';
                return;
            }
            grid.innerHTML = myItems.map(item => `
                <div class="glass rounded-2xl p-0 overflow-hidden">
                    <div class="h-32 w-full overflow-hidden">
                        <img src="${item.image}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-slate-900">${item.title}</h4>
                        <div class="text-sm text-slate-500 mt-1">${item.price}</div>
                        <button onclick="openDetail(${item.id})" class="w-full mt-2 px-3 py-2 rounded-lg bg-emerald-50 text-emerald-700 text-sm font-bold hover:bg-emerald-100">Edit / View</button>
                    </div>
                </div>
            `).join('');
        }

        // Render purchase history
        function renderPurchaseHistory(){
            const history = document.getElementById('purchase-history-list');
            history.innerHTML = `
                <div class="glass rounded-2xl p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-slate-900">Broken Monitor 22"</div>
                            <div class="text-sm text-slate-500">From EcoTech Solutions ‚Ä¢ ‚Çπ800</div>
                            <div class="text-xs text-slate-400 mt-1">Purchased on 2026-01-28</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-emerald-600">Delivered</div>
                        </div>
                    </div>
                </div>
                <div class="glass rounded-2xl p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="font-bold text-slate-900">Defunct DSLR</div>
                            <div class="text-sm text-slate-500">From GreenCycle Nagpur ‚Ä¢ ‚Çπ2,500</div>
                            <div class="text-xs text-slate-400 mt-1">Purchased on 2026-01-20</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm font-bold text-emerald-600">Delivered</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Open seller profile
        function openSellerProfile(){
            if(!window.currentDetailSeller) return;
            const seller = window.currentDetailSeller;
            document.getElementById('seller-name').textContent = seller.name;
            document.getElementById('seller-avatar').src = seller.avatar;
            document.getElementById('seller-rating').textContent = '‚≠ê ' + seller.rating + '/5';
            document.getElementById('seller-reviews').textContent = seller.reviews.length;
            document.getElementById('seller-points').textContent = seller.greenPoints.toLocaleString();
            if(seller.isVerified){
                document.getElementById('seller-verified').classList.remove('hidden');
            } else {
                document.getElementById('seller-verified').classList.add('hidden');
            }
            
            // Show seller's items
            const sellerItems = wasteItems.filter(item => item.sellerId === seller.id);
            const grid = document.getElementById('seller-items-grid');
            grid.innerHTML = sellerItems.map(item => `
                <article class="glass rounded-2xl p-0 overflow-hidden cursor-pointer hover:shadow-lg transition" onclick="openDetail(${item.id})">
                    <div class="h-32 w-full overflow-hidden">
                        <img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover">
                    </div>
                    <div class="p-4">
                        <h4 class="font-bold text-slate-900 text-sm">${item.title}</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="font-bold text-slate-800 text-sm">${item.price}</span>
                            <span class="text-xs px-2 py-1 rounded-full ${item.condition==='dead'? 'bg-red-100 text-red-700' : item.condition==='partial'? 'bg-yellow-50 text-yellow-700' : 'bg-emerald-50 text-emerald-700'}">${item.condition==='dead'? 'Dead' : item.condition==='partial'? 'Partial' : 'Works'}</span>
                        </div>
                    </div>
                </article>
            `).join('');
            
            // Show recent reviews with star ratings
            const reviewsList = document.getElementById('seller-reviews-list');
            reviewsList.innerHTML = seller.reviews.map((review, idx) => {
                const stars = '‚≠ê'.repeat(Math.floor(Math.random() * 2) + 4) + '‚òÜ'.repeat(5 - Math.floor(Math.random() * 2) - 4);
                return `
                    <div class="glass rounded-2xl p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="font-bold text-slate-900 text-sm">Customer ${idx + 1}</div>
                            <div class="text-sm text-amber-500">${stars}</div>
                        </div>
                        <p class="text-sm text-slate-600">${review}</p>
                    </div>
                `;
            }).join('');
            
            window.previousView = 'view-details';
            showView('view-seller');
        }

        // Handle buy or claim
        function handleBuyOrClaim(){
            const item = window.currentDetailItem;
            if(!item) return;
            
            if(item.price === 'Free'){
                alert('üÜì Item claimed successfully!\n\nYou can now arrange pickup with the seller.');
                // Could add to purchase history here
            } else {
                alert('üí≥ Proceeding to checkout...\n\nTotal: ' + item.price + '\n\nDemo mode ‚Äî simulated payment.');
                // Could integrate real payment here
            }
            showView('view-dashboard');
        }

        // Back button navigation
        function goBack(){
            showView(window.previousView || 'view-dashboard');
        }

        // initialize app
        showView('view-login');
        renderItems();
        renderMyListings();

        // Orientation handling: re-render or adjust layout on orientation change / resize
        function debounce(fn, wait=120){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

        function handleOrientation(){
            const isLandscape = window.innerWidth > window.innerHeight;
            document.body.classList.toggle('is-landscape', isLandscape);
            // re-render grid to ensure images / layout recompute if needed
            try{ renderItems(); }catch(e){/* ignore if not mounted */}
        }

        window.addEventListener('orientationchange', handleOrientation);
        window.addEventListener('resize', debounce(handleOrientation, 160));
        // initial call
        handleOrientation();
    </script>

    </main>
</body>
</html>